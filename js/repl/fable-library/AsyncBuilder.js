import{ensureErrorOrException}from"./Types.js";export class CancellationToken{constructor(e=!1){this._id=0,this._cancelled=e,this._listeners=new Map}get isCancelled(){return this._cancelled}cancel(){if(!this._cancelled){this._cancelled=!0;for(const[,e]of this._listeners)e()}}addListener(e){const r=this._id;return this._listeners.set(this._id++,e),r}removeListener(e){return this._listeners.delete(e)}register(e,r){const n=this,t=this.addListener(null==r?e:()=>e(r));return{Dispose(){n.removeListener(t)}}}Dispose(){}}export class OperationCanceledError extends Error{constructor(){super("The operation was canceled"),Object.setPrototypeOf(this,OperationCanceledError.prototype)}}export class Trampoline{static get maxTrampolineCallCount(){return 2e3}constructor(){this.callCount=0}incrementAndCheck(){return this.callCount++>Trampoline.maxTrampolineCallCount}hijack(e){this.callCount=0,setTimeout(e,0)}}export function protectedCont(e){return r=>{if(r.cancelToken.isCancelled)r.onCancel(new OperationCanceledError);else if(r.trampoline.incrementAndCheck())r.trampoline.hijack((()=>{try{e(r)}catch(e){r.onError(ensureErrorOrException(e))}}));else try{e(r)}catch(e){r.onError(ensureErrorOrException(e))}}}export function protectedBind(e,r){return protectedCont((n=>{e({onSuccess:e=>{try{r(e)(n)}catch(e){n.onError(ensureErrorOrException(e))}},onError:n.onError,onCancel:n.onCancel,cancelToken:n.cancelToken,trampoline:n.trampoline})}))}export function protectedReturn(e){return protectedCont((r=>r.onSuccess(e)))}export class AsyncBuilder{Bind(e,r){return protectedBind(e,r)}Combine(e,r){return this.Bind(e,(()=>r))}Delay(e){return protectedCont((r=>e()(r)))}For(e,r){const n=e[Symbol.iterator]();let t=n.next();return this.While((()=>!t.done),this.Delay((()=>{const e=r(t.value);return t=n.next(),e})))}Return(e){return protectedReturn(e)}ReturnFrom(e){return e}TryFinally(e,r){return protectedCont((n=>{e({onSuccess:e=>{r(),n.onSuccess(e)},onError:e=>{r(),n.onError(e)},onCancel:e=>{r(),n.onCancel(e)},cancelToken:n.cancelToken,trampoline:n.trampoline})}))}TryWith(e,r){return protectedCont((n=>{e({onSuccess:n.onSuccess,onCancel:n.onCancel,cancelToken:n.cancelToken,trampoline:n.trampoline,onError:e=>{try{r(e)(n)}catch(e){n.onError(ensureErrorOrException(e))}}})}))}Using(e,r){return this.TryFinally(r(e),(()=>e.Dispose()))}While(e,r){return e()?this.Bind(r,(()=>this.While(e,r))):this.Return(void 0)}Zero(){return protectedCont((e=>e.onSuccess(void 0)))}}export const singleton=new AsyncBuilder;